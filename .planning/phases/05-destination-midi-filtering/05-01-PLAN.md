---
phase: 05-destination-midi-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rp2040/midi_filters.h
  - rp2040/midi_filters.cpp
  - rp2040/midi_router.cpp
  - rp2040/config.h
  - rp2040/config.cpp
autonomous: true

must_haves:
  truths:
    - "Each output interface can block a message type independently of source filters"
    - "Source-side filters behave exactly as before"
    - "Destination filter settings persist through EEPROM and JSON config"
  artifacts:
    - path: "rp2040/midi_filters.h"
      provides: "Destination filter API declarations"
    - path: "rp2040/midi_filters.cpp"
      provides: "Destination filter storage and default initialization"
    - path: "rp2040/midi_router.cpp"
      provides: "Destination filter check inside per-destination routing loop"
    - path: "rp2040/config.cpp"
      provides: "destFilters JSON + EEPROM serialization"
  key_links:
    - from: "rp2040/midi_router.cpp"
      to: "rp2040/midi_filters.h"
      via: "isMidiDestFiltered call before forwarding"
      pattern: "isMidiDestFiltered"
    - from: "rp2040/config.cpp"
      to: "rp2040/midi_filters.h"
      via: "get/set destination filter functions"
      pattern: "destFilters|isMidiDestFiltered|getMidiDestFilterState|setMidiDestFilter"
    - from: "rp2040/config.cpp"
      to: "EEPROM"
      via: "updated offsets and size"
      pattern: "EEPROM_SIZE|CONFIG_EEPROM_SIZE"
---

<objective>
Add destination-side MIDI filter storage, routing checks, and persistent config support while preserving existing source filters.

Purpose: Enable per-output filtering without altering source-side behavior.
Output: Firmware changes in filters, router, and config serialization.
</objective>

<execution_context>
@/home/han/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/han/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-destination-midi-filtering/05-RESEARCH.md
@rp2040/midi_filters.h
@rp2040/midi_filters.cpp
@rp2040/midi_router.cpp
@rp2040/config.h
@rp2040/config.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add destination filter storage and API</name>
  <files>rp2040/midi_filters.h, rp2040/midi_filters.cpp</files>
  <action>
Add a separate destination filter matrix sized [MIDI_INTERFACE_COUNT][MIDI_MSG_COUNT].
Expose accessor/mutator helpers (e.g., get/set/isMidiDestFiltered) that mirror the existing source filter API and include bounds checks.
Initialize destination filters to all-allowed defaults and keep source filter behavior unchanged.
  </action>
  <verify>Confirm midi_filters.h declares destination filter helpers and midi_filters.cpp defines a new static matrix initialized to false.</verify>
  <done>Destination filter API exists with safe bounds checks and default all-allowed state.</done>
</task>

<task type="auto">
  <name>Task 2: Apply destination filters in the router loop</name>
  <files>rp2040/midi_router.cpp</files>
  <action>
Apply destination filters inside the per-destination routing loop, after destination mask and connection checks and before any forwarding calls.
Ensure destination filters are evaluated for all sources, including internal (IMU) messages.
Do not change source filter or channel filter ordering.
  </action>
  <verify>Locate the destination loop in routeMidiMessage() and confirm it calls isMidiDestFiltered() before forwarding to each interface.</verify>
  <done>Each output interface blocks filtered message types independently while source filters remain unchanged.</done>
</task>

<task type="auto">
  <name>Task 3: Persist destination filters in JSON + EEPROM</name>
  <files>rp2040/config.h, rp2040/config.cpp</files>
  <action>
Extend config serialization/deserialization to include a new top-level JSON property (e.g., destFilters) storing a 3x8 matrix.
Update EEPROM layout to store destination filters separately from source filters, expanding EEPROM size as needed and keeping offsets non-overlapping.
Ensure SAVEALL accepts configs without destFilters by defaulting destination filters to all-allowed.
Keep existing filters property as source filters to preserve backward compatibility.
  </action>
  <verify>Config JSON contains destFilters in configToJson(), updateConfigFromJson() handles missing destFilters, and EEPROM size/offsets are updated.</verify>
  <done>Destination filter settings survive READALL/SAVEALL and EEPROM save/load without altering existing source filter behavior.</done>
</task>

</tasks>

<verification>
- Firmware compiles: `./arduino-cli compile --fqbn rp2040:rp2040:rpipico:usbstack=tinyusb -v ./rp2040`
- READALL response includes a destFilters matrix with 3 interfaces and 8 message types each.
</verification>

<success_criteria>
- Destination filters are stored separately and applied per output interface.
- Source-side filters and channel filters behave exactly as before.
- Config JSON and EEPROM persist destination filter values with backward compatibility.
</success_criteria>

<output>
After completion, create `.planning/phases/05-destination-midi-filtering/05-01-SUMMARY.md`.
</output>
