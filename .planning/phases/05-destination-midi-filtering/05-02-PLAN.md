---
phase: 05-destination-midi-filtering
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - web_configurator/src/app.ts
  - web_configurator/src/validator.ts
  - web_configurator/index.html
autonomous: true

must_haves:
  truths:
    - "Web UI can view and edit destination filters alongside source filters"
    - "SAVEALL validates and sends destination filters without breaking existing source filters"
    - "READALL values populate destination filter checkboxes correctly"
  artifacts:
    - path: "web_configurator/index.html"
      provides: "Destination filter UI section and checkbox inputs"
    - path: "web_configurator/src/app.ts"
      provides: "UI serialization/deserialization for destFilters"
    - path: "web_configurator/src/validator.ts"
      provides: "JSON schema accepting destFilters matrix"
  key_links:
    - from: "web_configurator/src/app.ts"
      to: "web_configurator/index.html"
      via: "DOM lookup IDs for dest filter inputs"
      pattern: "dest|df-"
    - from: "web_configurator/src/app.ts"
      to: "web_configurator/src/validator.ts"
      via: "validateConfig on JSON with destFilters"
      pattern: "destFilters"
    - from: "web_configurator/src/app.ts"
      to: "SerialHandler send"
      via: "SAVEALL payload includes destFilters"
      pattern: "destFilters"
---

<objective>
Expose destination filter matrices in the web configurator UI and validation pipeline.

Purpose: Let users configure per-destination filters without impacting existing source filters.
Output: Updated UI layout, JSON schema, and serialization logic.
</objective>

<execution_context>
@/home/han/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/han/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-destination-midi-filtering/05-RESEARCH.md
@web_configurator/index.html
@web_configurator/src/app.ts
@web_configurator/src/validator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add destination filter UI section</name>
  <files>web_configurator/index.html</files>
  <action>
Add a destination filter section mirroring the existing source filter layout, with a clear heading per interface.
Create checkbox inputs for each interface/message type using a distinct ID pattern (e.g., df-{iface}-{msg}) to avoid collisions.
Keep the existing source filter UI unchanged and preserve layout consistency.
  </action>
  <verify>Open index.html and confirm a destination filter block exists with 3 interface groups and 8 message checkboxes each.</verify>
  <done>UI contains destination filter controls with unique IDs per interface/message.</done>
</task>

<task type="auto">
  <name>Task 2: Serialize and apply destination filters in app logic</name>
  <files>web_configurator/src/app.ts</files>
  <action>
Extend buildConfigJson() to include destFilters using the same inverted checkbox logic (checked = allowed, stored = blocked).
Update applyConfigToUI() to populate destination filter checkboxes from destFilters when present; default to all-allowed if missing.
Ensure SAVEALL payload includes destFilters and READALL handling does not break existing filters/channels/imu behavior.
  </action>
  <verify>Search for destFilters in app.ts and confirm both buildConfigJson() and applyConfigToUI() handle it.</verify>
  <done>Destination filters round-trip between UI and JSON with correct inverted logic.</done>
</task>

<task type="auto">
  <name>Task 3: Update validator schema for destination filters</name>
  <files>web_configurator/src/validator.ts</files>
  <action>
Extend the JSON schema to accept a destFilters property shaped as a 3x8 boolean matrix.
Allow destFilters to be optional to support older firmware responses; keep existing filters schema unchanged.
  </action>
  <verify>Schema includes destFilters and validateConfig accepts config JSONs with or without it.</verify>
  <done>Validation passes for SAVEALL payloads containing destFilters and legacy payloads without it.</done>
</task>

</tasks>

<verification>
- Build the web configurator: `cd web_configurator && npm run build`
- In the UI, set a destination filter checkbox, Send config, and confirm JSON payload includes destFilters with expected values.
</verification>

<success_criteria>
- Web UI can edit destination filters per interface/message type.
- Validator accepts configs with destFilters and preserves existing source filter validation.
- UI applies READALL destFilters values correctly with inverted checkbox logic.
</success_criteria>

<output>
After completion, create `.planning/phases/05-destination-midi-filtering/05-02-SUMMARY.md`.
</output>
