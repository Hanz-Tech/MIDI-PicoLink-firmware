---
phase: 01-generic-midi-router
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - rp2040/serial_midi_handler.cpp
autonomous: false
gap_closure: true
must_haves:
  truths:
    - "Note On and Note Off from Serial MIDI route correctly to USB Device and USB Host without stuck or missing notes"
  artifacts:
    - path: "rp2040/serial_midi_handler.cpp"
      provides: "Serial NoteOn handler normalizes velocity-0 into NoteOff subtype"
      contains: "localSerialOnNoteOn"
  key_links:
    - from: "rp2040/serial_midi_handler.cpp"
      to: "routeMidiMessage"
      via: "msg.subType set to NoteOff when velocity == 0"
      pattern: "velocity\s*==\s*0"
---

<objective>
Normalize Serial MIDI velocity-0 NoteOn events into NoteOff routing to prevent stuck/missing notes when forwarded to USB Device and USB Host.

Purpose: Close UAT gap where Serial-sourced notes stick or drop after the router refactor.
Output: Serial MIDI handler sets correct NoteOff subtype for velocity-0 NoteOn messages.
</objective>

<execution_context>
@/home/han/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/han/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-generic-midi-router/01-UAT.md
@.planning/phases/01-generic-midi-router/01-02-SUMMARY.md
@rp2040/serial_midi_handler.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Normalize Serial velocity-0 NoteOn to NoteOff subtype</name>
  <files>rp2040/serial_midi_handler.cpp</files>
  <action>
    Update localSerialOnNoteOn so that when velocity == 0 it sets msg.subType = 1 (NoteOff) instead of 0.
    Keep msg.type as MIDI_MSG_NOTE, preserve channel/note/velocity fields, and still call routeMidiMessage(MIDI_INTERFACE_SERIAL, msg).
    Do not change the dedicated NoteOff handler; this normalization only applies to NoteOn events with velocity 0.
  </action>
  <verify>./arduino-cli compile --fqbn rp2040:rp2040:rpipico:usbstack=tinyusb -v ./rp2040</verify>
  <done>Serial NoteOn handler maps velocity-0 to NoteOff subtype and firmware compiles without errors.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify Serial NoteOn velocity-0 behavior on hardware</name>
  <action>Confirm velocity-0 NoteOn from Serial behaves like NoteOff on USB Device/Host output.</action>
  <what-built>Serial NoteOn velocity-0 normalization to NoteOff routing</what-built>
  <how-to-verify>
    1. Flash firmware to the RP2040.
    2. Send Note On messages from Serial MIDI with velocity 0 and with velocity > 0.
    3. Observe USB Device output: velocity-0 events should behave like Note Off (no stuck notes), and normal Note On/Off pairs should trigger cleanly.
    4. Repeat with USB Host output if available.
  </how-to-verify>
  <resume-signal>Type "approved" if notes behave correctly or describe the remaining issue.</resume-signal>
</task>

</tasks>

<verification>
- UAT Test 2 passes: serial-sourced Note On/Off route correctly with no stuck/missing notes.
</verification>

<success_criteria>
- Serial NoteOn velocity-0 is treated as NoteOff in routing.
- No stuck notes observed when routing Serial MIDI to USB Device (and USB Host if tested).
</success_criteria>

<output>
After completion, create `.planning/phases/01-generic-midi-router/01-03-SUMMARY.md`
</output>
