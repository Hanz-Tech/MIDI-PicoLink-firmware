---
phase: 01-generic-midi-router
plan: 04
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - rp2040/midi_router.h
  - rp2040/midi_router.cpp
  - rp2040/imu_handler.cpp
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "IMU-generated MIDI CC messages are routed through routeMidiMessage() instead of direct interface sends"
    - "IMU routing respects per-destination flags without bypassing the generic router"
  artifacts:
    - path: "rp2040/imu_handler.cpp"
      provides: "IMU CC output uses routeMidiMessage with destination mask"
      contains: "routeMidiMessage"
    - path: "rp2040/midi_router.h"
      provides: "Router supports destination mask or internal source routing"
      contains: "routeMidiMessage"
    - path: "rp2040/midi_router.cpp"
      provides: "Router honors destination mask and avoids LED trigger for internal sources"
      contains: "destMask"
  key_links:
    - from: "rp2040/imu_handler.cpp"
      to: "rp2040/midi_router.h"
      via: "routeMidiMessage call with destination mask"
      pattern: "routeMidiMessage\(.*destMask"
---

<objective>
Route IMU-generated MIDI CC messages through the generic router while preserving per-destination routing flags and avoiding direct interface sends.

Purpose: Close the Phase 01 gap where IMU CCs bypass routeMidiMessage(), ensuring all routing flows through the centralized filter/forward path.
Output: Updated router to accept destination masks and IMU handler to use routeMidiMessage() for CC output.
</objective>

<execution_context>
@/home/han/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/han/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-generic-midi-router/01-generic-midi-router-VERIFICATION.md
@rp2040/midi_router.h
@rp2040/midi_router.cpp
@rp2040/imu_handler.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend routeMidiMessage to support destination masks and internal source</name>
  <files>rp2040/midi_router.h, rp2040/midi_router.cpp</files>
  <action>
    Update the router API to allow callers to specify explicit destinations without duplicating routing logic.

    In `rp2040/midi_router.h`:
    - Replace the `typedef MidiInterfaceType MidiSource;` with a new enum that includes the existing interface values plus an internal source value (e.g., `MIDI_SOURCE_INTERNAL = MIDI_INTERFACE_COUNT`).
    - Add destination mask constants (bitmask) for USB Host, USB Device, and Serial (e.g., `ROUTE_TO_SERIAL`, `ROUTE_TO_USB_DEVICE`, `ROUTE_TO_USB_HOST`, and `ROUTE_TO_ALL`).
    - Add a new overload: `void routeMidiMessage(MidiSource source, const MidiMessage &msg, uint8_t destMask);`
    - Keep the existing 2-arg routeMidiMessage declaration for all current handlers.

    In `rp2040/midi_router.cpp`:
    - Implement the 3-arg overload to:
      1. Apply channel filtering the same way as the existing function.
      2. Apply source filtering only when `source` is a real interface (Serial/USB Device/USB Host). Skip source filter for internal source.
      3. Iterate over the three real interfaces; forward only to destinations included in `destMask`.
      4. Preserve per-destination filters (`isMidiFiltered(dest, msg.type)`) and existing connection checks (`isConnectedToComputer`, `midi_host_mounted`).
    - Rework the existing 2-arg routeMidiMessage to call the 3-arg overload with a mask of “all destinations except source”.
    - LED behavior:
      - For internal source, do not trigger LEDs.
      - For Serial/USB sources, keep existing behavior (USB Device Clock does not trigger LED).
    - Keep realtime Clock debug suppression intact.

    Keep all existing message type forwarding behavior intact; only change routing selection logic and source handling.
  </action>
  <verify>
    - `rg "routeMidiMessage\(.*destMask" rp2040/midi_router.h rp2040/midi_router.cpp` shows the new overload and its usage
    - `rg "MIDI_SOURCE_INTERNAL|ROUTE_TO_" rp2040/midi_router.h` shows new source and mask constants
    - Router still calls `forwardToInterface` and keeps channel/filter checks
  </verify>
  <done>The router supports explicit destination masks and an internal source without changing existing handler behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Route IMU CC output through routeMidiMessage with destination mask</name>
  <files>rp2040/imu_handler.cpp</files>
  <action>
    Update IMU CC output to use the generic router and remove direct interface sends.

    In `rp2040/imu_handler.cpp`:
    - Add `#include "midi_router.h"`.
    - Rework `sendIMUMidiCC()` to:
      - Build a `MidiMessage` with `type = MIDI_MSG_CONTROL_CHANGE`, `channel`, `data1 = cc`, `data2 = value`, and `subType = 0`.
      - Compute `destMask` from `toSerial`, `toUSBDevice`, and `toUSBHost` using the new mask constants.
      - Call `routeMidiMessage(MIDI_SOURCE_INTERNAL, msg, destMask)`.
    - Remove direct calls to `sendSerialMidiControlChange`, `USB_D.sendControlChange`, and `sendControlChange` from this function.
    - Do not introduce new debug prints or LED triggers here (router handles those).

    Preserve the rest of IMU logic unchanged.
  </action>
  <verify>
    - `rg "sendSerialMidiControlChange|USB_D.sendControlChange|sendControlChange" rp2040/imu_handler.cpp` returns no matches
    - `rg "routeMidiMessage" rp2040/imu_handler.cpp` shows the IMU routing call
  </verify>
  <done>IMU CC output uses routeMidiMessage with explicit destination selection and no direct interface sends remain.</done>
</task>

</tasks>

<verification>
- IMU CC output routes through routeMidiMessage with destination mask control.
- No direct multi-interface sends remain in `sendIMUMidiCC()`.
</verification>

<success_criteria>
- IMU-generated CC messages are routed via the generic router and respect per-destination flags.
- Router preserves existing handler behavior while supporting internal-source routing.
</success_criteria>

<output>
After completion, create `.planning/phases/01-generic-midi-router/01-04-SUMMARY.md`
</output>
