---
phase: 02-module-structure
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - rp2040/usb_host_midi_handlers.h
  - rp2040/usb_host_midi_handlers.cpp
  - rp2040/usb_device_midi_handlers.h
  - rp2040/usb_device_midi_handlers.cpp
  - rp2040/rp2040.ino
  - rp2040/usb_host_wrapper.h
  - rp2040/usb_host_wrapper.cpp
autonomous: true

must_haves:
  truths:
    - "USB Host MIDI handlers live in a dedicated usb_host_midi_handlers module separate from rp2040.ino"
    - "USB Device MIDI handlers live in a dedicated usb_device_midi_handlers module separate from rp2040.ino"
    - "rp2040.ino contains only setup/loop orchestration — no MIDI handler implementations"
    - "Firmware compiles and all three MIDI interfaces route messages identically to before the split"
  artifacts:
    - path: "rp2040/usb_host_midi_handlers.h"
      provides: "USB Host handler declarations + C-style wrapper declarations + setupUsbHostHandlers() for registration"
      contains: "setupUsbHostHandlers"
    - path: "rp2040/usb_host_midi_handlers.cpp"
      provides: "USB Host handler thin wrappers (calling routeMidiMessage) + C-style wrappers + registration function"
      contains: "routeMidiMessage"
    - path: "rp2040/usb_device_midi_handlers.h"
      provides: "USB Device handler declarations + setupUsbDeviceHandlers() for registration"
      contains: "setupUsbDeviceHandlers"
    - path: "rp2040/usb_device_midi_handlers.cpp"
      provides: "USB Device handler thin wrappers (calling routeMidiMessage) + registration function"
      contains: "routeMidiMessage"
    - path: "rp2040/rp2040.ino"
      provides: "Slim orchestration-only main sketch with setup/loop"
      contains: "setupUsbHostHandlers"
  key_links:
    - from: "rp2040/usb_host_midi_handlers.cpp"
      to: "rp2040/midi_router.h"
      via: "#include and routeMidiMessage() calls"
      pattern: '#include "midi_router.h"'
    - from: "rp2040/usb_device_midi_handlers.cpp"
      to: "rp2040/midi_router.h"
      via: "#include and routeMidiMessage() calls"
      pattern: '#include "midi_router.h"'
    - from: "rp2040/usb_host_wrapper.cpp"
      to: "rp2040/usb_host_midi_handlers.h"
      via: "Handler function declarations moved from usb_host_wrapper.h"
      pattern: '#include "usb_host_midi_handlers.h"'
    - from: "rp2040/rp2040.ino"
      to: "rp2040/usb_host_midi_handlers.h"
      via: "setupUsbHostHandlers() call in setup1()"
      pattern: "setupUsbHostHandlers"
    - from: "rp2040/rp2040.ino"
      to: "rp2040/usb_device_midi_handlers.h"
      via: "setupUsbDeviceHandlers() call in setup()"
      pattern: "setupUsbDeviceHandlers"
---

<objective>
Extract all USB Host and USB Device MIDI handlers from rp2040.ino into dedicated modules, leaving rp2040.ino as a slim setup/loop orchestrator.

Purpose: Fulfills ARCH-02 — the 811-line monolith (already reduced by Phase 1 to ~280 lines of handler wrappers + orchestration) becomes a clean orchestration file of ~100 lines. Each MIDI interface now has its own module: USB Host handlers in `usb_host_midi_handlers.cpp`, USB Device handlers in `usb_device_midi_handlers.cpp`, Serial handlers already in `serial_midi_handler.cpp`.

Output: Two new handler modules, a dramatically slimmed rp2040.ino, and verified compilation.
</objective>

<execution_context>
@/home/han/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/han/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-generic-midi-router/01-01-SUMMARY.md
@.planning/phases/01-generic-midi-router/01-02-SUMMARY.md
@.planning/phases/02-module-structure/02-01-SUMMARY.md
@rp2040/rp2040.ino
@rp2040/usb_host_wrapper.h
@rp2040/usb_host_wrapper.cpp
@rp2040/midi_router.h
@rp2040/midi_instances.h
@rp2040/pin_config.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract USB Host and USB Device handlers into dedicated modules</name>
  <files>rp2040/usb_host_midi_handlers.h, rp2040/usb_host_midi_handlers.cpp, rp2040/usb_device_midi_handlers.h, rp2040/usb_device_midi_handlers.cpp, rp2040/rp2040.ino, rp2040/usb_host_wrapper.h, rp2040/usb_host_wrapper.cpp</files>
  <action>
  **Create `rp2040/usb_host_midi_handlers.h`:**

  ```cpp
  #ifndef USB_HOST_MIDI_HANDLERS_H
  #define USB_HOST_MIDI_HANDLERS_H

  #include <Arduino.h>

  // USB Host MIDI handler functions (called by processMidiPacket in usb_host_wrapper.cpp)
  void usbh_onNoteOnHandle(byte channel, byte note, byte velocity);
  void usbh_onNoteOffHandle(byte channel, byte note, byte velocity);
  void usbh_onPolyphonicAftertouchHandle(byte channel, byte note, byte amount);
  void usbh_onControlChangeHandle(byte channel, byte controller, byte value);
  void usbh_onProgramChangeHandle(byte channel, byte program);
  void usbh_onAftertouchHandle(byte channel, byte value);
  void usbh_onPitchBendHandle(byte channel, int value);
  void usbh_onSysExHandle(byte *array, unsigned size);
  void usbh_onMidiClockHandle();
  void usbh_onMidiStartHandle();
  void usbh_onMidiContinueHandle();
  void usbh_onMidiStopHandle();

  // C-style wrappers (needed by usb_host_wrapper.cpp extern declarations)
  // These are defined with MIDI library Channel type for TinyUSB compatibility
  void setupUsbHostHandlers();

  #endif // USB_HOST_MIDI_HANDLERS_H
  ```

  **Create `rp2040/usb_host_midi_handlers.cpp`:**

  Move the following from rp2040.ino into this new file:
  1. All 12 `usbh_on*Handle()` handler functions (the thin wrappers from Phase 1 that call `routeMidiMessage()`)
  2. All 12 C-style wrapper functions (`onNoteOff`, `onNoteOn`, `onPolyphonicAftertouch`, etc. — lines 63-74 of current rp2040.ino)
  3. Create a `setupUsbHostHandlers()` function — this is currently a no-op since USB Host handlers are called directly by `processMidiPacket()` in `usb_host_wrapper.cpp`, not registered via callbacks. But having this function provides a clean initialization point if needed in the future. For now, it can be empty or just log "USB Host handlers initialized".

  Required includes in the .cpp:
  - `"usb_host_midi_handlers.h"`
  - `"midi_router.h"` (for `routeMidiMessage`, `MidiMessage`, `MidiSource`)
  - `<MIDI.h>` (for `USING_NAMESPACE_MIDI` and `Channel` type used by C-style wrappers)

  The C-style wrappers use the MIDI library's `Channel` type (via `USING_NAMESPACE_MIDI`). Add `USING_NAMESPACE_MIDI` at the top of the .cpp file (after includes) to bring this type into scope.

  **Create `rp2040/usb_device_midi_handlers.h`:**

  ```cpp
  #ifndef USB_DEVICE_MIDI_HANDLERS_H
  #define USB_DEVICE_MIDI_HANDLERS_H

  #include <Arduino.h>

  // Register USB Device MIDI callback handlers on the USB_D instance
  // Call this from setup() after USB_D.begin()
  void setupUsbDeviceHandlers();

  #endif // USB_DEVICE_MIDI_HANDLERS_H
  ```

  Note: The USB Device handler function declarations (usbd_on*) do NOT need to be in the header since they're only used internally — they're set as callbacks via `USB_D.setHandle*()` in `setupUsbDeviceHandlers()`.

  **Create `rp2040/usb_device_midi_handlers.cpp`:**

  Move the following from rp2040.ino into this new file:
  1. All 11 `usbd_on*()` handler functions (the thin wrappers from Phase 1 that call `routeMidiMessage()`)
  2. Create `setupUsbDeviceHandlers()` which contains the USB_D.setHandle* registrations currently in rp2040.ino setup() lines 126-136:
     ```cpp
     void setupUsbDeviceHandlers() {
         USB_D.setHandleNoteOn(usbd_onNoteOn);
         USB_D.setHandleNoteOff(usbd_onNoteOff);
         USB_D.setHandleControlChange(usbd_onControlChange);
         USB_D.setHandleProgramChange(usbd_onProgramChange);
         USB_D.setHandleAfterTouchChannel(usbd_onAftertouch);
         USB_D.setHandlePitchBend(usbd_onPitchBend);
         USB_D.setHandleSystemExclusive(usbd_onSysEx);
         USB_D.setHandleClock(usbd_onClock);
         USB_D.setHandleStart(usbd_onStart);
         USB_D.setHandleContinue(usbd_onContinue);
         USB_D.setHandleStop(usbd_onStop);
     }
     ```

  Required includes in the .cpp:
  - `"usb_device_midi_handlers.h"`
  - `"midi_router.h"` (for `routeMidiMessage`, `MidiMessage`, `MidiSource`)
  - `"midi_instances.h"` (for `USB_D` — needed for handler registration)

  The usbd_on* functions should be declared `static` or just have file-internal linkage since they're only referenced by setupUsbDeviceHandlers() within the same file. However, if keeping them non-static is simpler and matches existing style (the codebase doesn't use static for handler functions), that's fine.

  **Update `rp2040/usb_host_wrapper.h`:**
  1. Remove all 12 `usbh_on*Handle()` declarations (lines 54-65) — these now live in `usb_host_midi_handlers.h`
  2. Add `#include "usb_host_midi_handlers.h"` so that `usb_host_wrapper.cpp` can still call the handlers

  Alternatively, have `usb_host_wrapper.cpp` include `usb_host_midi_handlers.h` directly instead of going through the header. Choose whichever keeps the include graph cleaner — prefer having `usb_host_wrapper.cpp` include `usb_host_midi_handlers.h` directly.

  **Update `rp2040/usb_host_wrapper.cpp`:**
  1. Add `#include "usb_host_midi_handlers.h"` if not already available via `usb_host_wrapper.h`
  2. Remove the `extern` declarations for the C-style wrappers (lines 310-321: `extern void onNoteOff(...)` etc.) — these are now provided by `usb_host_midi_handlers.h` or the linker resolves them from the .cpp file
  3. The `processMidiPacket()` function calls `usbh_on*Handle()` directly — these are resolved at link time from `usb_host_midi_handlers.cpp`

  **Update `rp2040/rp2040.ino`:**
  1. Add `#include "usb_host_midi_handlers.h"` and `#include "usb_device_midi_handlers.h"`
  2. Remove ALL forward declarations for USB Host handlers (lines 49-60)
  3. Remove ALL C-style wrapper functions (lines 63-74)
  4. Remove ALL forward declarations for USB Device handlers (lines 77-87)
  5. Remove ALL usbh_on*Handle() implementations (entire "USB Host MIDI message handlers" section, lines 280-569 post-Phase1)
  6. Remove ALL usbd_on*() implementations (entire "USB Device MIDI message handlers" section, lines 571-810 post-Phase1)
  7. Remove `USING_NAMESPACE_MIDI` (line 42) — this is now in usb_host_midi_handlers.cpp
  8. In `setup()`:
     - Replace the 11 `USB_D.setHandle*()` lines (126-136) with a single call: `setupUsbDeviceHandlers();`
     - Move `USB_D.begin(MIDI_CHANNEL_OMNI)` to BEFORE `setupUsbDeviceHandlers()` (it already is, just ensure ordering)
  9. Keep everything else in setup(): USB descriptors, Serial init, LED init, USB mount wait, filter init, EEPROM load, IMU init, Serial MIDI init, Core sync, blink
  10. Keep setup1(), loop(), loop1() unchanged (loop1 still calls usb_host_wrapper_task)

  After these changes, rp2040.ino should be approximately 100-120 lines containing ONLY:
  - Includes (~15 lines)
  - `isConnectedToComputer` global + `USBHost` instance + `core1_booting` + `timeout` (~5 lines)
  - `setup()` (~70 lines — same logic, just handler registration replaced with setupUsbDeviceHandlers())
  - `loop()` (~15 lines)
  - `setup1()` (~35 lines)
  - `loop1()` (~3 lines)
  </action>
  <verify>
  - Files `rp2040/usb_host_midi_handlers.h`, `rp2040/usb_host_midi_handlers.cpp`, `rp2040/usb_device_midi_handlers.h`, `rp2040/usb_device_midi_handlers.cpp` all exist
  - `grep -c "routeMidiMessage" rp2040/usb_host_midi_handlers.cpp` shows 12 calls
  - `grep -c "routeMidiMessage" rp2040/usb_device_midi_handlers.cpp` shows 11 calls
  - `grep -c "routeMidiMessage" rp2040/rp2040.ino` shows 0 (no handler code remains)
  - `grep -c "usbh_on\|usbd_on" rp2040/rp2040.ino` shows 0 (no handler implementations)
  - `grep "setupUsbDeviceHandlers\|setupUsbHostHandlers" rp2040/rp2040.ino` shows setup calls
  - `wc -l rp2040/rp2040.ino` is approximately 100-130 lines
  </verify>
  <done>All USB Host and USB Device handlers are extracted into dedicated modules, rp2040.ino is a slim orchestration file, and handler registration is done via setup functions</done>
</task>

<task type="auto">
  <name>Task 2: Verify firmware compiles with arduino-cli</name>
  <files>rp2040/rp2040.ino</files>
  <action>
  Attempt to compile the firmware using the Arduino CLI:

  ```bash
  ./arduino-cli compile --fqbn rp2040:rp2040:rpipico:usbstack=tinyusb -v ./rp2040
  ```

  If `./arduino-cli` is not available (the committed binary is a Windows .exe), try:
  - `arduino-cli compile --fqbn rp2040:rp2040:rpipico:usbstack=tinyusb -v ./rp2040`
  - Or locate: `which arduino-cli` or `find / -name arduino-cli -type f 2>/dev/null`

  If arduino-cli is genuinely unavailable:
  - Document that compilation verification is deferred to the user
  - Manually verify all include chains resolve correctly:
    - `usb_host_midi_handlers.cpp` → includes `midi_router.h`, `usb_host_midi_handlers.h`, `<MIDI.h>`
    - `usb_device_midi_handlers.cpp` → includes `midi_router.h`, `usb_device_midi_handlers.h`, `midi_instances.h`
    - `usb_host_wrapper.cpp` → includes `usb_host_midi_handlers.h` (for handler function declarations)
    - `rp2040.ino` → includes both new handler headers
  - Check for common issues:
    - No circular includes between new handler modules
    - `USING_NAMESPACE_MIDI` is in the right .cpp file (usb_host_midi_handlers.cpp)
    - `USB_D` is accessible in usb_device_midi_handlers.cpp via midi_instances.h
    - C-style wrappers (onNoteOn etc.) are still linkable from usb_host_wrapper.cpp
    - `extern void onNoteOff(...)` declarations in usb_host_wrapper.cpp match function signatures in usb_host_midi_handlers.cpp

  If compilation fails, fix the errors. Common issues:
  - Missing includes
  - Duplicate symbol definitions (function defined in both old and new location)
  - Type visibility issues (Channel type from MIDI namespace)
  - Linker errors for C-style wrapper functions
  </action>
  <verify>
  - Arduino CLI compile command exits with 0 (success), OR
  - If arduino-cli unavailable: manual code review confirms no include chain breaks, no duplicate definitions, no missing symbols
  </verify>
  <done>Firmware compiles successfully confirming the module extraction is correct, all handler functions link properly, and no symbols are missing or duplicated</done>
</task>

</tasks>

<verification>
- rp2040.ino contains only setup/loop orchestration (~100-130 lines)
- Zero handler implementations remain in rp2040.ino
- USB Host handlers live in usb_host_midi_handlers.cpp with their C-style wrappers
- USB Device handlers live in usb_device_midi_handlers.cpp with registration function
- usb_host_wrapper.cpp can still call usbh_on*Handle() functions (resolved at link time)
- Firmware compiles with arduino-cli (or manual review if CLI unavailable)
- All three MIDI interfaces route messages identically to before the split
</verification>

<success_criteria>
1. rp2040.ino line count is ~100-130 (down from 811 original, ~280 post-Phase1)
2. Each MIDI interface has its own handler module: usb_host_midi_handlers, usb_device_midi_handlers, serial_midi_handler
3. setupUsbDeviceHandlers() replaces 11 individual setHandle* calls in setup()
4. No handler code or forward declarations remain in rp2040.ino
5. Firmware compiles successfully
6. The module split is purely organizational — zero behavioral change
</success_criteria>

<output>
After completion, create `.planning/phases/02-module-structure/02-02-SUMMARY.md`
</output>
