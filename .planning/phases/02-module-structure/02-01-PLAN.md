---
phase: 02-module-structure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rp2040/pin_config.h
  - rp2040/rp2040.ino
  - rp2040/led_utils.h
  - rp2040/led_utils.cpp
  - rp2040/imu_handler.h
  - rp2040/serial_midi_handler.cpp
autonomous: true

must_haves:
  truths:
    - "All GPIO pin assignments are defined in a single pin_config.h header"
    - "No magic pin numbers exist in rp2040.ino, led_utils.h, imu_handler.h, or serial_midi_handler.cpp — all reference pin_config.h"
    - "Firmware compiles identically to before — pin centralization is a pure refactor with zero behavioral change"
  artifacts:
    - path: "rp2040/pin_config.h"
      provides: "Centralized GPIO pin definitions for all hardware interfaces"
      contains: "HOST_PIN_DP"
    - path: "rp2040/led_utils.h"
      provides: "LED utilities with pin definitions removed (uses pin_config.h)"
      contains: '#include "pin_config.h"'
    - path: "rp2040/imu_handler.h"
      provides: "IMU handler with I2C pin definitions removed (uses pin_config.h)"
      contains: '#include "pin_config.h"'
  key_links:
    - from: "rp2040/led_utils.h"
      to: "rp2040/pin_config.h"
      via: "#include for LED_IN_PIN and LED_OUT_PIN"
      pattern: '#include "pin_config.h"'
    - from: "rp2040/imu_handler.h"
      to: "rp2040/pin_config.h"
      via: "#include for IMU_I2C_SDA_PIN and IMU_I2C_SCL_PIN"
      pattern: '#include "pin_config.h"'
    - from: "rp2040/serial_midi_handler.cpp"
      to: "rp2040/pin_config.h"
      via: "#include for SERIAL_MIDI_RX_PIN and SERIAL_MIDI_TX_PIN"
      pattern: '#include "pin_config.h"'
---

<objective>
Create a centralized `pin_config.h` header containing ALL GPIO pin assignments, then update every module to use it instead of local pin definitions.

Purpose: Fulfills ARCH-03 — no magic numbers scattered in source files. When adding new hardware interfaces (like CV/Clock output in the next milestone), all pin assignments are visible in one place, preventing conflicts and making the hardware map obvious.

Output: New `rp2040/pin_config.h` file, updated includes in 5 existing files with local pin definitions removed.
</objective>

<execution_context>
@/home/han/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/han/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-generic-midi-router/01-01-SUMMARY.md
@rp2040/rp2040.ino
@rp2040/led_utils.h
@rp2040/led_utils.cpp
@rp2040/imu_handler.h
@rp2040/imu_handler.cpp
@rp2040/serial_midi_handler.cpp
@rp2040/usb_host_wrapper.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pin_config.h with all GPIO pin definitions</name>
  <files>rp2040/pin_config.h</files>
  <action>
  Create `rp2040/pin_config.h` with include guards and ALL hardware pin assignments gathered from across the codebase. Group by functional area with clear comments:

  ```cpp
  #ifndef PIN_CONFIG_H
  #define PIN_CONFIG_H

  // ============================================
  // MIDI PicoLink — Centralized Pin Configuration
  // ============================================
  // All GPIO pin assignments in one place.
  // See schematic for physical connections.

  // --- USB Host (PIO USB) ---
  #define HOST_PIN_DP   12   // D+ pin for PIO USB Host (D- = D+ + 1 = GPIO 13)

  // --- Serial MIDI (DIN/TRS via Serial1) ---
  #define SERIAL_MIDI_RX_PIN  1   // GPIO pin for Serial1 RX (MIDI In)
  #define SERIAL_MIDI_TX_PIN  0   // GPIO pin for Serial1 TX (MIDI Out)

  // --- LED Indicators ---
  #define LED_IN_PIN    29   // LED for incoming MIDI activity (USB)
  #define LED_OUT_PIN   19   // LED for outgoing MIDI activity (Serial)

  // --- IMU (I2C via Wire1) ---
  #define IMU_I2C_SDA_PIN  26   // I2C SDA for IMU sensor
  #define IMU_I2C_SCL_PIN  27   // I2C SCL for IMU sensor

  // --- Debug UART (Serial2) ---
  #define DEBUG_UART_RX_PIN  25   // Serial2 RX for debug output
  #define DEBUG_UART_TX_PIN  24   // Serial2 TX for debug output

  #endif // PIN_CONFIG_H
  ```

  Notes:
  - `IMU_ADDRESS 0x68` is NOT a pin — keep it in `imu_handler.h` (it's an I2C address, not GPIO)
  - `LANGUAGE_ID 0x0409` in `usb_host_wrapper.h` is NOT a pin — leave it there
  - Serial MIDI pins are currently `int` variables in `serial_midi_handler.cpp` — convert them to `#define` constants since they never change at runtime
  - Debug UART pins (24/25) are currently hardcoded literals in `setup()` — define them here
  </action>
  <verify>
  - File `rp2040/pin_config.h` exists
  - `grep -c "define.*PIN" rp2040/pin_config.h` shows 8 pin definitions (HOST_PIN_DP, SERIAL_MIDI_RX_PIN, SERIAL_MIDI_TX_PIN, LED_IN_PIN, LED_OUT_PIN, IMU_I2C_SDA_PIN, IMU_I2C_SCL_PIN, DEBUG_UART_RX_PIN, DEBUG_UART_TX_PIN) — actually 9 counting DEBUG pins
  - Include guards `PIN_CONFIG_H` present
  </verify>
  <done>A single pin_config.h file contains every GPIO pin assignment used in the firmware, organized by functional area with descriptive comments</done>
</task>

<task type="auto">
  <name>Task 2: Update all modules to use pin_config.h and remove local pin definitions</name>
  <files>rp2040/rp2040.ino, rp2040/led_utils.h, rp2040/led_utils.cpp, rp2040/imu_handler.h, rp2040/serial_midi_handler.cpp</files>
  <action>
  Update each file that currently defines or hardcodes pin numbers:

  **`rp2040/rp2040.ino`:**
  1. Add `#include "pin_config.h"` near the top with other includes
  2. Remove `#define HOST_PIN_DP 12` (line 19) — now comes from pin_config.h
  3. Update `Serial2.setRX(25)` → `Serial2.setRX(DEBUG_UART_RX_PIN)` (line 103)
  4. Update `Serial2.setTX(24)` → `Serial2.setTX(DEBUG_UART_TX_PIN)` (line 104)
  5. The `HOST_PIN_DP` references in setup1() (line 248-249) will still work since pin_config.h provides the define

  **`rp2040/led_utils.h`:**
  1. Add `#include "pin_config.h"` after `#include <Arduino.h>`
  2. Remove `#define LED_IN_PIN 29` and `#define LED_OUT_PIN 19` — now come from pin_config.h
  3. All code using `LED_IN_PIN` and `LED_OUT_PIN` (in led_utils.cpp and rp2040.ino) continues to work through the include chain

  **`rp2040/led_utils.cpp`:**
  - No changes needed if led_utils.cpp already includes led_utils.h (which now pulls in pin_config.h). Verify this is the case.

  **`rp2040/imu_handler.h`:**
  1. Add `#include "pin_config.h"` after the existing Arduino.h include
  2. Remove `#define IMU_I2C_SDA_PIN 26` and `#define IMU_I2C_SCL_PIN 27` (lines 76-77) — now come from pin_config.h
  3. Keep `#define IMU_ADDRESS 0x68` in imu_handler.h — this is an I2C device address, not a GPIO pin

  **`rp2040/serial_midi_handler.cpp`:**
  1. Add `#include "pin_config.h"` with the other includes at the top
  2. Remove `int serialRxPin = 1;` and `int serialTxPin = 0;` (lines 13-14) — these runtime int variables become compile-time constants from pin_config.h
  3. Update `Serial1.setRX(serialRxPin)` → `Serial1.setRX(SERIAL_MIDI_RX_PIN)` (line 51)
  4. Update `Serial1.setTX(serialTxPin)` → `Serial1.setTX(SERIAL_MIDI_TX_PIN)` (line 52)
  5. Update the debug printf to use the new constant names: `dualPrintf("Serial MIDI Module: Initialized using pins: RX=%d, TX=%d\n", SERIAL_MIDI_RX_PIN, SERIAL_MIDI_TX_PIN);`

  **Verify no circular includes:** pin_config.h includes nothing except Arduino.h-level types (actually nothing — it uses only preprocessor defines, no includes needed in pin_config.h itself). All other headers include pin_config.h but pin_config.h doesn't include any project headers. Clean dependency.
  </action>
  <verify>
  - `grep -rn "HOST_PIN_DP" rp2040/` shows definition ONLY in pin_config.h, usage in rp2040.ino setup1()
  - `grep -rn "LED_IN_PIN\|LED_OUT_PIN" rp2040/` shows definition ONLY in pin_config.h, usage in led_utils files and rp2040.ino
  - `grep -rn "IMU_I2C_SDA_PIN\|IMU_I2C_SCL_PIN" rp2040/` shows definition ONLY in pin_config.h, usage in imu_handler.cpp
  - `grep -rn "SERIAL_MIDI_RX_PIN\|SERIAL_MIDI_TX_PIN" rp2040/` shows definition ONLY in pin_config.h, usage in serial_midi_handler.cpp
  - `grep -rn "serialRxPin\|serialTxPin" rp2040/` returns nothing (old int variables removed)
  - `grep -rn "setRX(25)\|setTX(24)" rp2040/` returns nothing (hardcoded literals replaced)
  - No duplicate pin definitions exist across the codebase
  </verify>
  <done>All GPIO pin definitions live exclusively in pin_config.h, with no magic numbers or duplicate definitions remaining in any source file</done>
</task>

</tasks>

<verification>
- `rp2040/pin_config.h` contains all 9 pin definitions (HOST_PIN_DP, SERIAL_MIDI_RX/TX, LED_IN/OUT, IMU_I2C_SDA/SCL, DEBUG_UART_RX/TX)
- No GPIO pin numbers are hardcoded as literals in any .ino, .cpp, or .h file (except pin_config.h itself)
- `rp2040/rp2040.ino` no longer defines HOST_PIN_DP
- `rp2040/led_utils.h` no longer defines LED_IN_PIN or LED_OUT_PIN
- `rp2040/imu_handler.h` no longer defines IMU_I2C_SDA_PIN or IMU_I2C_SCL_PIN
- `rp2040/serial_midi_handler.cpp` no longer has int serialRxPin/serialTxPin variables
</verification>

<success_criteria>
1. A single `pin_config.h` file contains every GPIO pin assignment
2. Every file that previously defined pins now includes pin_config.h instead
3. Zero duplicate pin definitions exist
4. Zero hardcoded pin number literals exist outside pin_config.h
5. The firmware's behavior is completely unchanged — this is a pure organizational refactor
</success_criteria>

<output>
After completion, create `.planning/phases/02-module-structure/02-01-SUMMARY.md`
</output>
