---
phase: 03-non-blocking-patterns
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rp2040/led_utils.h
  - rp2040/led_utils.cpp
autonomous: true

must_haves:
  truths:
    - "Blinking both LEDs no longer blocks the main loop; MIDI routing continues during LED patterns"
    - "USB/serial activity LEDs still pulse for 50ms as before"
    - "No delay() calls remain in LED blink helpers"
  artifacts:
    - path: "rp2040/led_utils.h"
      provides: "Non-blocking LED blink API"
      contains: "blinkBothLEDs"
    - path: "rp2040/led_utils.cpp"
      provides: "Blink state machine driven by millis()"
      contains: "handleLEDs"
  key_links:
    - from: "rp2040/led_utils.cpp"
      to: "rp2040/led_utils.h"
      via: "blinkBothLEDs schedules state used by handleLEDs"
      pattern: "blinkBothLEDs|handleLEDs"
---

<objective>
Replace the blocking LED blink helper with a millis()-driven state machine so LED patterns can run without stalling Core 0.

Purpose: Satisfies PERF-01 by eliminating delay() usage for LED patterns while preserving existing activity indicator behavior.

Output: Updated LED utilities with a non-blocking blink scheduler and integrated update step.
</objective>

<execution_context>
@/home/han/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/han/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-non-blocking-patterns/03-RESEARCH.md
@rp2040/led_utils.h
@rp2040/led_utils.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add non-blocking blink scheduler to led_utils</name>
  <files>rp2040/led_utils.h, rp2040/led_utils.cpp</files>
  <action>
  Implement a millis()-based blink state machine that schedules LED on/off steps without delay():

  - In `rp2040/led_utils.cpp`, add a static struct (or discrete static fields) for the blink pattern state:
    - `bool active`
    - `bool ledOn`
    - `uint8_t remainingTransitions` (on+off counts, e.g., times * 2)
    - `uint16_t intervalMs`
    - `uint32_t nextStepAt`
  - Update `handleLEDs()` to also advance the blink scheduler:
    - If `active` and `millis() >= nextStepAt`, toggle both LEDs together
    - Update `nextStepAt = millis() + intervalMs`
    - Decrement `remainingTransitions` when transitioning to OFF; when it reaches 0, set `active = false` and ensure both LEDs are LOW
    - Keep existing activity LED timers intact; do not change their 50ms behavior
  - Update `blinkBothLEDs(int times, int ms)` to be non-blocking:
    - Initialize the blink state (active, ledOn=false, remainingTransitions = times * 2, intervalMs = ms, nextStepAt = millis())
    - Return immediately (no delay())
  - Keep the function signature the same so call sites do not change.

  Notes:
  - If activity LEDs and blink overlap, prefer blink to visibly toggle both LEDs; activity timers can still turn LEDs off after 50ms, but the scheduler should re-assert the blink state on the next tick.
  - Avoid any new global side effects beyond the blink state variables.
  </action>
  <verify>
  - `grep -n "delay(.*)" rp2040/led_utils.cpp` returns no matches
  - `blinkBothLEDs` contains no loops or delays, only state initialization
  - `handleLEDs()` includes a blink state update block gated by `millis()`
  </verify>
  <done>LED blinking is driven by a millis()-based scheduler and `blinkBothLEDs()` returns immediately</done>
</task>

<task type="auto">
  <name>Task 2: Preserve existing activity LED timing behavior</name>
  <files>rp2040/led_utils.cpp</files>
  <action>
  Confirm the existing activity LED logic remains unchanged:
  - `triggerSerialLED()` and `triggerUsbLED()` still set their respective LED HIGH and start a 50ms timer
  - `handleLEDs()` still turns each activity LED off after 50ms using the `inLedStartMs`/`outLedStartMs` timers
  - The new blink scheduler should be additive and not remove/rename any of the activity-related state variables
  </action>
  <verify>
  - `handleLEDs()` still includes both `inLedActive` and `outLedActive` timing checks
  - `triggerSerialLED()`/`triggerUsbLED()` remain functionally identical to prior behavior (set HIGH + timestamp)
  </verify>
  <done>Activity LED pulses remain 50ms and are unaffected by the new blink scheduler</done>
</task>

</tasks>

<verification>
- `delay()` is no longer present in `rp2040/led_utils.cpp`
- Boot-time and SAVEALL blink calls no longer block the main loop
- Activity LEDs still pulse for ~50ms on MIDI traffic
</verification>

<success_criteria>
1. LED blink patterns use a millis()-based state machine and never block Core 0
2. LED activity indicators remain intact and responsive
3. No delay-based LED logic remains in the codebase
</success_criteria>

<output>
After completion, create `.planning/phases/03-non-blocking-patterns/03-01-SUMMARY.md`
</output>
